<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NiceGram App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0a0a1f, #000510);
            overflow: hidden;
            position: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loader-container {
            text-align: center;
            color: white;
            max-width: 300px;
            padding: 20px;
        }

        .loader {
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top: 3px solid #00ff88;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        h1 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 24px;
        }

        p {
            color: rgba(200, 255, 200, 0.8);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 100, 100, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .status {
            font-size: 14px;
            color: rgba(150, 255, 150, 0.7);
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="loader-container">
        <h1>NiceGram App</h1>
        <p>Загрузка безопасного приложения...</p>
        <div class="loader"></div>
        <div class="status" id="status">Инициализация системы</div>
        
        <div class="error" id="error">
            <strong>Ошибка загрузки:</strong>
            <div id="error-message"></div>
            <button onclick="location.reload()" style="
                margin-top: 10px;
                background: #00ff88;
                border: none;
                padding: 8px 16px;
                border-radius: 5px;
                color: black;
                font-weight: bold;
                cursor: pointer;
            ">
                Обновить страницу
            </button>
        </div>
    </div>

    <script>
        // Конфигурация - УКАЖИТЕ СВОЙ СЕРВЕР!
        const APP_SOURCE = 'https://ваш-сервер.com/nicegram/app.js';
        // ИЛИ используйте GitHub Raw (если приватный репозиторий с доступом по токену)
        // const APP_SOURCE = 'https://raw.githubusercontent.com/ваш-логин/nicegram-private/main/dist/app.js';
        
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        function updateStatus(text) {
            const status = document.getElementById('status');
            if (status) {
                status.textContent = text;
            }
            console.log('[NiceGram Loader]', text);
        }
        
        function showError(message) {
            console.error('[NiceGram Loader] Ошибка:', message);
            const error = document.getElementById('error');
            const errorMsg = document.getElementById('error-message');
            if (error && errorMsg) {
                errorMsg.textContent = message;
                error.style.display = 'block';
            }
        }
        
        async function loadApp() {
            updateStatus('Подключение к серверу...');
            
            try {
                // Загружаем основное приложение
                const response = await fetch(APP_SOURCE, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const appCode = await response.text();
                
                // Проверяем, что это наш код
                if (!appCode.includes('NiceGram') || appCode.length < 1000) {
                    throw new Error('Неверный формат приложения');
                }
                
                updateStatus('Проверка безопасности...');
                
                // Создаем и выполняем скрипт
                const script = document.createElement('script');
                
                // Оборачиваем код в функцию для изоляции
                script.textContent = `
                    (function() {
                        ${appCode}
                        
                        // Запускаем приложение если Telegram WebApp доступен
                        if (window.Telegram && window.Telegram.WebApp) {
                            if (typeof initNiceGram === 'function') {
                                initNiceGram(window.Telegram.WebApp);
                            }
                        }
                    })();
                `;
                
                document.head.appendChild(script);
                updateStatus('Запуск приложения...');
                
                // Даем время на инициализацию
                setTimeout(() => {
                    const appContainer = document.querySelector('.nicegram-container');
                    if (!appContainer) {
                        throw new Error('Приложение не загрузилось');
                    }
                }, 2000);
                
            } catch (error) {
                showError(error.message || 'Неизвестная ошибка');
                updateStatus('Ошибка загрузки');
            }
        }
        
        // Запускаем загрузку
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadApp, 1000);
        });
        
        // Fallback: если через 10 секунд не загрузилось
        setTimeout(() => {
            const appContainer = document.querySelector('.nicegram-container');
            if (!appContainer) {
                showError('Таймаут загрузки. Проверьте подключение к интернету.');
            }
        }, 10000);
    </script>
</body>
</html>
